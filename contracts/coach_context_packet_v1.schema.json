{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://sg-spec.local/schemas/coach_context_packet_v1.schema.json",
  "title": "CoachContextPacket v1",
  "description": "Input context for Smart Guitar AI Coach. Contains practice session data without PII.",
  "type": "object",
  "additionalProperties": false,
  "required": ["schema_id", "schema_version", "created_at_utc", "session_id", "request", "evidence"],

  "allOf": [
    {
      "$comment": "Hard-block forbidden PII fields at top-level.",
      "not": {
        "anyOf": [
          { "required": ["player_id"] },
          { "required": ["account_id"] },
          { "required": ["user_id"] },
          { "required": ["email"] },
          { "required": ["phone"] },
          { "required": ["name"] }
        ]
      }
    }
  ],

  "properties": {
    "schema_id": {
      "const": "coach_context_packet_v1"
    },
    "schema_version": {
      "const": "v1"
    },
    "created_at_utc": {
      "type": "string",
      "description": "RFC3339 timestamp in UTC"
    },
    "session_id": {
      "type": "string",
      "minLength": 1,
      "maxLength": 128,
      "pattern": "^[A-Za-z0-9][A-Za-z0-9._:-]{0,126}[A-Za-z0-9]?$",
      "description": "Practice session identifier (device-local, not user-identifying)"
    },

    "request": {
      "type": "object",
      "additionalProperties": false,
      "required": ["kind", "template_id", "template_version"],
      "properties": {
        "kind": {
          "type": "string",
          "enum": ["groove_feedback", "practice_summary", "technique_hint", "repertoire_suggest"],
          "description": "Job kind."
        },
        "template_id": {
          "type": "string",
          "minLength": 1,
          "description": "Template identifier."
        },
        "template_version": {
          "type": "string",
          "minLength": 1,
          "description": "Template version (semver)."
        },
        "focus_area": {
          "type": "string",
          "description": "Optional focus area for coaching."
        }
      }
    },

    "evidence": {
      "type": "object",
      "additionalProperties": false,
      "required": ["groove_metrics", "session_stats"],
      "properties": {
        "groove_metrics": {
          "type": "object",
          "description": "Groove Layer analysis results",
          "properties": {
            "tempo_stability": { "type": "number", "minimum": 0, "maximum": 1 },
            "beat_accuracy": { "type": "number", "minimum": 0, "maximum": 1 },
            "dynamics_range": { "type": "number", "minimum": 0, "maximum": 1 },
            "articulation_clarity": { "type": "number", "minimum": 0, "maximum": 1 },
            "phrase_coherence": { "type": "number", "minimum": 0, "maximum": 1 }
          }
        },
        "session_stats": {
          "type": "object",
          "properties": {
            "duration_seconds": { "type": "integer", "minimum": 0 },
            "notes_played": { "type": "integer", "minimum": 0 },
            "tempo_bpm": { "type": "number", "minimum": 20, "maximum": 300 },
            "key_signature": { "type": "string" },
            "time_signature": { "type": "string" }
          }
        },
        "pattern_refs": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["pattern_id"],
            "properties": {
              "pattern_id": { "type": "string", "minLength": 1 },
              "name": { "type": "string" },
              "category": { "type": "string" }
            }
          }
        }
      }
    },

    "device_context": {
      "type": "object",
      "properties": {
        "instrument_model": { "type": "string", "enum": ["headed", "headless"] },
        "firmware_version": { "type": "string" },
        "tuning": { "type": "string" }
      }
    }
  }
}
