{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://smartguitar.dev/schemas/agentic-ai/coach-decision.schema.json",
  "title": "Smart Guitar Coach Decision Contracts",
  "description": "Event schemas for coaching decisions: CoachDecision, GuidanceRequest, GuidanceEnvelope.",

  "$defs": {
    "Mode": {
      "type": "string",
      "enum": ["NEUTRAL", "PRACTICE", "PERFORMANCE", "EXPLORATION"]
    },

    "Backoff": {
      "type": "string",
      "enum": ["L0", "L1", "L2", "L3", "L4"]
    },

    "Granularity": {
      "type": "string",
      "enum": ["none", "summary", "phrase", "micro"]
    },

    "Tone": {
      "type": "string",
      "enum": ["silent", "supportive", "suggestive", "instructive"]
    },

    "Modality": {
      "type": "string",
      "enum": ["haptic", "visual", "audio", "text"]
    },

    "FeedbackIntent": {
      "type": "string",
      "enum": [
        "repeat_once",
        "wait_for_count_in",
        "start_on_downbeat",
        "finish_two_bars",
        "slow_down_enable_pulse",
        "clarify_exercise_length",
        "subdivision_support",
        "backbeat_anchor",
        "reduce_motion",
        "timing_centering",
        "raise_challenge"
      ],
      "description": "The type of coaching feedback intent (CoachIntent)"
    },

    "CueKey": {
      "type": "string",
      "examples": [
        "one_more_take_same_tempo",
        "wait_for_count_in_then_enter",
        "start_on_downbeat",
        "finish_two_bars_slow_if_needed",
        "slow_down_and_use_pulse",
        "stop_after_two_bars",
        "add_subdivision_pulse",
        "emphasize_2_and_4",
        "smaller_strum_less_extra",
        "aim_center_of_click",
        "nice_lock_in_bump_tempo"
      ],
      "description": "Content key for the cue to deliver (from cue bindings)"
    },

    "CoachDecision": {
      "type": "object",
      "description": "Output from the coach: what feedback to give and what to do next.",
      "required": ["type", "exercise_id", "take_id", "decision_id", "intent", "plan"],
      "properties": {
        "type": { "const": "CoachDecision" },
        "exercise_id": { "type": "string" },
        "take_id": { "type": "string" },
        "decision_id": { "type": "string" },
        "intent": {
          "type": "object",
          "required": ["feedback_intent", "cue_key", "single_point", "priority"],
          "properties": {
            "feedback_intent": { "$ref": "#/$defs/FeedbackIntent" },
            "cue_key": { "$ref": "#/$defs/CueKey" },
            "single_point": { "type": "boolean", "description": "If true, deliver only one cue" },
            "priority": { "type": "string", "enum": ["low", "medium", "high"] }
          }
        },
        "plan": {
          "type": "object",
          "required": ["next_take", "bpm_next", "pattern_next", "count_in_beats", "success_criteria"],
          "properties": {
            "next_take": { "type": "string", "enum": ["repeat_same", "simplify", "advance", "switch_exercise"] },
            "bpm_next": { "type": "number", "minimum": 20, "maximum": 300 },
            "pattern_next": { "type": "string" },
            "count_in_beats": { "type": "integer", "minimum": 0 },
            "success_criteria": { "type": "string", "description": "Human-readable success criteria" }
          }
        },
        "safety": {
          "type": "object",
          "properties": {
            "allow_realtime": { "type": "boolean" },
            "max_interruptions_this_take": { "type": "integer", "minimum": 0 }
          }
        }
      }
    },

    "SessionSignals": {
      "type": "object",
      "description": "Real-time session signals for policy engine decisions.",
      "required": ["timeSinceLastNoteOnMs", "phraseBoundaryDetected", "timeSincePhraseBoundaryMs", "ignoreStreak", "silencePreference", "userExplicitQuiet"],
      "properties": {
        "timeSinceLastNoteOnMs": { "type": "integer", "minimum": 0, "description": "0 when currently playing notes, increases in pauses" },
        "phraseBoundaryDetected": { "type": "boolean" },
        "timeSincePhraseBoundaryMs": { "type": "integer", "minimum": 0 },
        "ignoreStreak": { "type": "integer", "minimum": 0, "description": "Consecutive ignored prompts/cues" },
        "silencePreference": { "type": "number", "minimum": 0, "maximum": 1, "description": "0=chatty, 1=prefer silence" },
        "userExplicitQuiet": { "type": "boolean", "description": "Hard override: user demanded quiet" },
        "modeConfidence": { "type": "number", "minimum": 0, "maximum": 1, "description": "Confidence of mode inference" }
      }
    },

    "GuidanceRequest": {
      "type": "object",
      "description": "Request to policy engine: should we initiate feedback now?",
      "required": ["type", "t_ms", "mode", "backoff", "signals", "decision"],
      "properties": {
        "type": { "const": "GuidanceRequest" },
        "t_ms": { "type": "integer" },
        "mode": { "$ref": "#/$defs/Mode" },
        "backoff": { "$ref": "#/$defs/Backoff" },
        "signals": { "$ref": "#/$defs/SessionSignals" },
        "decision": {
          "type": "object",
          "required": ["decision_id", "feedback_intent", "cue_key", "priority", "single_point"],
          "properties": {
            "decision_id": { "type": "string" },
            "feedback_intent": { "$ref": "#/$defs/FeedbackIntent" },
            "cue_key": { "$ref": "#/$defs/CueKey" },
            "priority": { "type": "string", "enum": ["low", "medium", "high"] },
            "single_point": { "type": "boolean" }
          }
        },
        "constraints": {
          "type": "object",
          "properties": {
            "realtime_ok": { "type": "boolean" },
            "suggested_modalities": {
              "type": "array",
              "items": { "$ref": "#/$defs/Modality" }
            },
            "max_cues": { "type": "integer", "minimum": 0 }
          }
        }
      }
    },

    "GuidanceEnvelope": {
      "type": "object",
      "description": "Policy engine output: whether/when/how to deliver feedback.",
      "required": ["type", "t_ms", "shouldInitiate", "reason"],
      "properties": {
        "type": { "const": "GuidanceEnvelope" },
        "t_ms": { "type": "integer" },
        "shouldInitiate": { "type": "boolean" },
        "reason": {
          "type": "string",
          "enum": [
            "ok",
            "explicit_quiet",
            "realtime_disabled_or_none",
            "performance_tone_block",
            "performance_micro_block",
            "insufficient_pause",
            "no_phrase_boundary",
            "phrase_boundary_debounce",
            "performance_extra_pause",
            "budget_or_cooldown",
            "stochastic_budget",
            "no_modality_available"
          ]
        },
        "selected": {
          "type": "object",
          "description": "Only present if shouldInitiate=true",
          "properties": {
            "modality": { "$ref": "#/$defs/Modality" },
            "tone": { "$ref": "#/$defs/Tone" },
            "granularity": { "$ref": "#/$defs/Granularity" },
            "maxCues": { "type": "integer", "minimum": 0 }
          }
        },
        "timing": {
          "type": "object",
          "properties": {
            "deliver_at_ms": { "type": "integer" },
            "delivery_window_ms": { "type": "integer" }
          }
        },
        "policy_snapshot": {
          "type": "object",
          "description": "Effective policy after clamps (for debugging/logging)",
          "properties": {
            "interruptBudgetPerMin": { "type": "number" },
            "minPauseMs": { "type": "integer" },
            "betweenPhraseOnly": { "type": "boolean" }
          }
        }
      }
    },

    "InterventionDecision": {
      "type": "object",
      "description": "Internal decision structure from GuidanceEngine.",
      "required": ["shouldInitiate", "reason", "mode", "backoff", "policy"],
      "properties": {
        "shouldInitiate": { "type": "boolean" },
        "reason": { "type": "string" },
        "mode": { "$ref": "#/$defs/Mode" },
        "backoff": { "$ref": "#/$defs/Backoff" },
        "policy": { "type": "object", "description": "Effective GuidancePolicy after clamps" },
        "modality": { "$ref": "#/$defs/Modality" },
        "maxCues": { "type": "integer" }
      }
    }
  },

  "oneOf": [
    { "$ref": "#/$defs/CoachDecision" },
    { "$ref": "#/$defs/GuidanceRequest" },
    { "$ref": "#/$defs/GuidanceEnvelope" }
  ]
}
