{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://smartguitar.dev/schemas/agentic-ai/guidance-policy.schema.json",
  "title": "Smart Guitar Guidance Policy (Mode Ã— Backoff) + Runtime Engine Config",
  "type": "object",
  "additionalProperties": false,
  "required": ["version", "matrix", "runtime"],
  "properties": {
    "version": {
      "type": "string",
      "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+$"
    },
    "matrix": {
      "description": "Policy matrix keyed by mode then backoff level.",
      "type": "object",
      "additionalProperties": false,
      "required": ["NEUTRAL", "PRACTICE", "PERFORMANCE", "EXPLORATION"],
      "properties": {
        "NEUTRAL": { "$ref": "#/$defs/backoffMap" },
        "PRACTICE": { "$ref": "#/$defs/backoffMap" },
        "PERFORMANCE": { "$ref": "#/$defs/backoffMap" },
        "EXPLORATION": { "$ref": "#/$defs/backoffMap" }
      }
    },
    "runtime": {
      "description": "Engine configuration used by the reference implementation.",
      "type": "object",
      "additionalProperties": false,
      "required": [
        "tokenBucket",
        "safeWindow",
        "globalRules",
        "modalityAvailability"
      ],
      "properties": {
        "tokenBucket": {
          "type": "object",
          "additionalProperties": false,
          "required": ["maxTokens", "stochasticRounding", "cooldownAfterInterventionMs"],
          "properties": {
            "maxTokens": { "type": "number", "minimum": 0, "maximum": 10 },
            "stochasticRounding": { "type": "boolean" },
            "cooldownAfterInterventionMs": { "type": "integer", "minimum": 0, "maximum": 600000 }
          }
        },
        "safeWindow": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "phraseBoundaryRequiredAtOrAboveBackoff",
            "minPauseMsByBackoff",
            "phraseBoundaryDebounceMs",
            "silenceGateExtraPauseMs"
          ],
          "properties": {
            "phraseBoundaryRequiredAtOrAboveBackoff": {
              "description": "If backoff >= this level, require phrase boundary gating even if policy says otherwise.",
              "type": "string",
              "enum": ["L0", "L1", "L2", "L3", "L4"]
            },
            "minPauseMsByBackoff": {
              "type": "object",
              "additionalProperties": false,
              "required": ["L0", "L1", "L2", "L3", "L4"],
              "properties": {
                "L0": { "type": "integer", "minimum": 0, "maximum": 10000 },
                "L1": { "type": "integer", "minimum": 0, "maximum": 10000 },
                "L2": { "type": "integer", "minimum": 0, "maximum": 10000 },
                "L3": { "type": "integer", "minimum": 0, "maximum": 10000 },
                "L4": { "type": "integer", "minimum": 0, "maximum": 10000 }
              }
            },
            "phraseBoundaryDebounceMs": {
              "description": "Minimum time after a detected phrase boundary before the system can initiate an intervention.",
              "type": "integer",
              "minimum": 0,
              "maximum": 5000
            },
            "silenceGateExtraPauseMs": {
              "description": "If silence preference is high or ignore streak is high, add this extra pause requirement.",
              "type": "integer",
              "minimum": 0,
              "maximum": 10000
            }
          }
        },
        "globalRules": {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "performanceNeverInstructive",
            "performanceNoMicroGranularity",
            "backoffAtOrAboveL2ForcesBetweenPhraseOnly",
            "ignoreStreakClamp"
          ],
          "properties": {
            "performanceNeverInstructive": { "type": "boolean" },
            "performanceNoMicroGranularity": { "type": "boolean" },
            "backoffAtOrAboveL2ForcesBetweenPhraseOnly": { "type": "boolean" },
            "ignoreStreakClamp": {
              "type": "object",
              "additionalProperties": false,
              "required": ["ignoreStreakThreshold", "maxInterruptBudgetPerMin", "extraPauseMs"],
              "properties": {
                "ignoreStreakThreshold": { "type": "integer", "minimum": 1, "maximum": 20 },
                "maxInterruptBudgetPerMin": { "type": "number", "minimum": 0, "maximum": 10 },
                "extraPauseMs": { "type": "integer", "minimum": 0, "maximum": 10000 }
              }
            }
          }
        },
        "modalityAvailability": {
          "description": "Static availability of modalities on the device/build (can be overridden per-session in code).",
          "type": "object",
          "additionalProperties": false,
          "required": ["haptic", "visual", "audio", "text"],
          "properties": {
            "haptic": { "type": "boolean" },
            "visual": { "type": "boolean" },
            "audio": { "type": "boolean" },
            "text": { "type": "boolean" }
          }
        }
      }
    }
  },
  "$defs": {
    "backoffMap": {
      "type": "object",
      "additionalProperties": false,
      "required": ["L0", "L1", "L2", "L3", "L4"],
      "properties": {
        "L0": { "$ref": "#/$defs/guidancePolicy" },
        "L1": { "$ref": "#/$defs/guidancePolicy" },
        "L2": { "$ref": "#/$defs/guidancePolicy" },
        "L3": { "$ref": "#/$defs/guidancePolicy" },
        "L4": { "$ref": "#/$defs/guidancePolicy" }
      }
    },
    "guidancePolicy": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "interruptBudgetPerMin",
        "minPauseMs",
        "betweenPhraseOnly",
        "realTimeEnabled",
        "granularity",
        "maxCuesPerIntervention",
        "modalityWeights",
        "tone",
        "assist"
      ],
      "properties": {
        "interruptBudgetPerMin": { "type": "number", "minimum": 0, "maximum": 10 },
        "minPauseMs": {
          "description": "Policy-level pause threshold before initiating. Engine may further clamp/increase this.",
          "type": ["integer", "null"],
          "minimum": 0,
          "maximum": 20000
        },
        "betweenPhraseOnly": { "type": "boolean" },
        "realTimeEnabled": { "type": "boolean" },
        "granularity": { "type": "string", "enum": ["none", "summary", "phrase", "micro"] },
        "maxCuesPerIntervention": { "type": "integer", "minimum": 0, "maximum": 10 },
        "modalityWeights": {
          "type": "object",
          "additionalProperties": false,
          "required": ["haptic", "visual", "audio", "text"],
          "properties": {
            "haptic": { "type": "number", "minimum": 0, "maximum": 1 },
            "visual": { "type": "number", "minimum": 0, "maximum": 1 },
            "audio": { "type": "number", "minimum": 0, "maximum": 1 },
            "text": { "type": "number", "minimum": 0, "maximum": 1 }
          }
        },
        "tone": { "type": "string", "enum": ["silent", "supportive", "suggestive", "instructive"] },
        "assist": {
          "type": "object",
          "additionalProperties": false,
          "required": ["tempoStabilization", "phraseBoundaryMarking", "callResponse", "postSessionRecap"],
          "properties": {
            "tempoStabilization": { "type": "boolean" },
            "phraseBoundaryMarking": { "type": "boolean" },
            "callResponse": { "type": "boolean" },
            "postSessionRecap": { "type": "boolean" }
          }
        }
      }
    }
  }
}
